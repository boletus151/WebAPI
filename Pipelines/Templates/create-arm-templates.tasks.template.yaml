steps:
  - task: PowerShell@2
    displayName: Create ARM-Templates
    inputs:
      targetType: "filePath"
      filePath: $(Build.SourcesDirectory)/$(ProjectName)/$(Path_Scripts)/arm-templates-create.ps1
      arguments: -toolPath $(Build.SourcesDirectory)/$(ProjectName)/$(Path_CreatorTool) -configFile $(Build.SourcesDirectory)/$(ProjectName)/$(ArmCreatorConfigurationFile)

  - task: AzurePowerShell@5
    displayName: Validate ARM-Templates
    inputs:
      azureSubscription: $(SERVICE_CONNECTION_NAME)
      ScriptType: "filePath"
      ScriptPath: $(Build.SourcesDirectory)/$(ProjectName)/$(Path_Scripts)/arm-templates-validate.ps1
      azurePowerShellVersion: LatestVersion
      ScriptArguments: 
        -resourceGroup $(RG) 
        -templatesPath "$(Build.SourcesDirectory)/$(ProjectName)/$(Path_ArmTemplates)" -parameters $(Build.SourcesDirectory)/$(ProjectName)/$(ArmParameters)

  - task: AzurePowerShell@5
    displayName: Upload templates to Azure Template Specs
    inputs:
      azureSubscription: $(SERVICE_CONNECTION_NAME)
      ScriptType: "FilePath"
      ScriptPath: $(Build.SourcesDirectory)/$(ProjectName)/$(Path_Scripts)/template-specs-upload.ps1
      azurePowerShellVersion: LatestVersion
      ScriptArguments: 
        -templatesPath $(Build.SourcesDirectory)/$(ProjectName)/$(Path_ArmTemplates) 
        -resourceGroup $(RG) 
        -version original

  - task: AzurePowerShell@5
    displayName: Validate Master Template
    inputs:
      azureSubscription: $(SERVICE_CONNECTION_NAME)
      ScriptType: "InlineScript"
      azurePowerShellVersion: "LatestVersion"
      Inline: |
        Test-AzResourceGroupDeployment -SkipTemplateParameterPrompt -ResourceGroupName $(RG) -TemplateFile $(Build.SourcesDirectory)/$(ProjectName)/$(ArmMasterTemplate) -TemplateParameterFile $(Build.SourcesDirectory)/$(ProjectName)/$(ArmParameters)
  
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: $(Build.SourcesDirectory)/$(ProjectName)/$(Path_ArmTemplates)
      artifactName: ARMTemplates
      publishLocation: pipeline #Input alias: artifactType. string. Required. Allowed values: pipeline (Azure Pipelines), filepath (A file share)